<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="gov.pbc.xjcloud.provider.contract.mapper.auditManage.PlanManagementMapper">

    <resultMap id="PlanCheckListMapper" type="gov.pbc.xjcloud.provider.contract.entity.PlanCheckList">
        <result column="id" property="id"/>
        <result column="project_code" property="projectCode"/>
        <result column="project_name" property="projectName"/>
        <result column="project_type" property="projectType"/>
        <result column="implementing_agency_id" property="implementingAgencyId"/>
        <result column="audit_object_id" property="auditObjectId"/>
        <result column="audit_nature_id" property="auditNatureId"/>
        <result column="audit_year" property="auditYear"/>
        <result column="status" property="status"/>
        <result column="question_entry_id" property="questionEntryId"/>
        <result column="problem_severity_id" property="problemSeverityId"/>
        <result column="rectify_situation_id" property="rectifySituationId"/>
        <result column="problem_characterization" property="problemCharacterization"/>
        <result column="problem_description" property="problemDescription"/>
        <result column="may_affect" property="mayAffect"/>
        <result column="rectification_suggestions" property="rectificationSuggestions"/>
        <result column="audit_basis" property="auditBasis"/>
        <result column="audit_classification_id" property="auditClassificationId"/>
        <result column="auditing_experience" property="auditingExperience"/>
        <result column="risk_assessment_id" property="riskAssessmentId"/>
        <result column="instance_id" property="instanceId"/>
        <result column="plan_time" property="planTime"/>
    </resultMap>
    <insert id="addCheckAttention">
        insert into user_attention_check (user_id,check_id) values
        <foreach collection="checkArr" item="checkId" separator=",">
            (#{userId},#{checkId})
        </foreach>
    </insert>
    <delete id="cancelCheckAttention">
        delete from user_attention_check where user_id=#{userId}
        and check_id in
        <foreach collection="checkArr" close=")" item="checkId" separator="," open="(">
            #{checkId}
        </foreach>
    </delete>

    <sql id="select">
        a.id,
        a.project_code,
        a.project_name,
        a.project_type,
        a.implementing_agency_id,
        a.audit_object_id,
        en3.`name` audit_nature_id,
        a.audit_year,
        a.status,
        a.question_entry_id,
        a.problem_severity_id,
        a.rectify_situation_id,
        a.problem_characterization,
        a.problem_description,
        a.may_affect,
        a.rectification_suggestions,
        a.audit_basis,
        a.audit_classification_id,
        a.auditing_experience,
        a.plan_time,
        a.risk_assessment_id
    </sql>

    <select id="selectPlanCheckListByAdmin" resultMap="PlanCheckListMapper">
        SELECT
        <include refid="select"/>
        FROM
        `plan_check_list` a
        LEFT JOIN entry_info en3 on a.audit_nature_id = en3.id
        where a.del_flag='0' and a.`status` != '1001'
        and a.implementing_agency_id like concat('%',concat(#{query.implementingAgencyId},'%'))
        <if test="query.projectName!=null and query.projectName!=''">
            and a.project_name like concat('%',concat(#{query.projectName},'%'))
        </if>
        <if test="query.status!=null and query.status!=''">
            and a.`status` = #{query.status, jdbcType=VARCHAR}
        </if>
        <if test="query.auditYear!=null and query.auditYear!=''">
            and a.audit_year like concat('%',concat(#{query.auditYear},'%'))
        </if>
        <if test="query.auditNatureId!=null and query.auditNatureId!=''">
            and a.audit_nature_id like concat('%',concat(#{query.auditNatureId},'%'))
        </if>
        <if test="query.projectType!=null and query.projectType!=''">
            and a.project_type like concat('%',concat(#{query.projectType},'%'))
        </if>

    </select>

    <select id="selectPlanCheckList" resultMap="PlanCheckListMapper">
        SELECT
        <include refid="select"/>
        FROM
        `plan_check_list` a
        LEFT JOIN entry_info en3 on a.audit_nature_id = en3.id
        where a.del_flag='0'
        and a.created_by like concat('%',concat(#{query.createdBy},'%'))
        <if test="query.projectName!=null and query.projectName!=''">
            and a.project_name like concat('%',concat(#{query.projectName},'%'))
        </if>
        <if test="query.status!=null and query.status!=''">
            and a.`status` = #{query.status, jdbcType=VARCHAR}
        </if>
        <if test="query.problemCharacterization!=null and query.problemCharacterization!=''">
            and a.problem_characterization like concat('%',concat(#{query.problemCharacterization},'%'))
        </if>
        <if test="query.problemDescription!=null and query.problemDescription!=''">
            and a.problem_description like concat('%',concat(#{query.problemDescription},'%'))
        </if>
        <if test="query.implementingAgencyId!=null and query.implementingAgencyId!=''">
            and a.implementing_agency_id like concat('%',concat(#{query.implementingAgencyId},'%'))
        </if>
        <if test="query.auditYear!=null and query.auditYear!=''">
            and a.audit_year like concat('%',concat(#{query.auditYear},'%'))
        </if>
        <if test="query.auditNatureId!=null and query.auditNatureId!=''">
            and a.audit_nature_id like concat('%',concat(#{query.auditNatureId},'%'))
        </if>
        <if test="query.projectType!=null and query.projectType!=''">
            and a.project_type like concat('%',concat(#{query.projectType},'%'))
        </if>
        <if test="query.impUserId!=null and query.impUserId!=''">
            and a.imp_user_id like concat('%',concat(#{query.impUserId},'%'))
        </if>
        <if test="query.impAdminId!=null and query.impAdminId!=''">
            and a.imp_admin_id like concat('%',concat(#{query.impAdminId},'%'))
        </if>
        <if test="query.auditUserId!=null and query.auditUserId!=''">
            and a.audit_user_id like concat('%',concat(#{query.auditUserId},'%'))
        </if>
        <if test="query.auditAdminId!=null and query.auditAdminId!=''">
            and a.audit_admin_id like concat('%',concat(#{query.auditAdminId},'%'))
        </if>

    </select>

    <select id="selectEntryByCategoryId" resultType="java.util.HashMap">
        SELECT id,`NAME` name,name1,name2,name3 FROM `entry_info` where category_fk = #{categoryId, jdbcType=VARCHAR} and del_flag = '0'
    </select>

    <select id="selectEntryById" resultType="java.util.HashMap">
        SELECT id,`NAME` name FROM `entry_info` where id = #{id, jdbcType=VARCHAR} and del_flag = '0'
    </select>
    <select id="getShortPlans" resultType="java.util.HashMap">
        SELECT a.id, a.status FROM `plan_check_list` a where a.del_flag='0'
        <if test="status!=null and status!=''">
            and a.status =#{status}
        </if>
        <if test="auditYear!=null and auditYear!=''">
            and a.audit_year like concat('%',concat(#{auditYear},'%'))
        </if>
        <choose>
            <when test="deptChild!=null and deptChild.size()>0">
                and a.audit_object_id in
                <foreach collection="deptChild" separator="," open="(" close=")" item="auditObj">
                    #{auditObj.deptId}
                </foreach>
            </when>
            <otherwise>
                and a.audit_object_id = 0
            </otherwise>
        </choose>
    </select>
    <select id="selectTypePage" resultType="gov.pbc.xjcloud.provider.contract.entity.PlanCheckList">
        SELECT
        <include refid="select"/>
        FROM
        `plan_check_list` a
        LEFT JOIN entry_info en3 on a.audit_nature_id = en3.id
        where a.del_flag='0'
        <if test="query.auditYear!=null and query.auditYear!=''">
            and a.audit_year like concat('%',concat(#{query.auditYear},'%'))
        </if>
        <if test="query.projectName!=null and query.projectName!=''">
            and a.project_name like concat('%',concat(#{query.projectName},'%'))
        </if>
        <if test="query.projectType!=null and query.projectType!=''">
            and a.project_type like concat('%',concat(#{query.projectType},'%'))
        </if>
        <if test="query.problemCharacterization!=null and query.problemCharacterization!=''">
            and a.problem_characterization like concat('%',concat(#{query.problemCharacterization},'%'))
        </if>
        <if test="query.problemDescription!=null and query.problemDescription!=''">
            and a.problem_description like concat('%',concat(#{query.problemDescription},'%'))
        </if>
        <if test="query.deptId!=null and query.deptId!=''">
            and a.implementing_agency_id =#{query.deptId}
        </if>
        <if test="query.normalStatus!=null and query.normalStatus!=''">
            and a.status = #{query.normalStatus}
        </if>
        <if test="query.auditObj!=null and query.auditObj.size()>0">
            and a.audit_object_id in
            <foreach collection="query.auditObj" separator="," open="(" close=")" item="auditObj">
                #{auditObj.deptId}
            </foreach>
        </if>
        <choose>
            <when test="query.type=='all'">

            </when>
            <when test="query.type=='todo'">
                and a.`status` !='1003'
            </when>
            <when test="query.type=='done'">
                and a.`status` =='1003'
            </when>
            <when test="query.type=='delay'">
                and a.delay_date is not null
            </when>

        </choose>

    </select>
    <select id="countPlan" resultType="java.util.Map">
        select
        count(1) planSum,
        sum(case when status='1013' then 1 else 0 end) finishCount,
        sum(case when status!='1013'
        then 1 else 0 end) nofinishCount,
        sum(case when delay_date is not null then 1 else 0 end) timeoutCount
        from
        plan_check_list where del_flag='0'
        <if test='agencyId!=null and agencyId!=""'>
            and implementing_agency_id='${agencyId}'
        </if>
    </select>
    <select id="selectAttentionPage" resultType="gov.pbc.xjcloud.provider.contract.entity.PlanCheckList">
        SELECT
        a.id,
        a.project_code,
        a.project_name,
        a.implementing_agency_id,
        a.audit_object_id,
        a.audit_nature_id,
        a.audit_year,
        a.status,
        a.question_entry_id,
        a.problem_severity_id,
        rectify_situation_entry.name as rectify_situation_id,
        a.problem_characterization,
        a.problem_description,
        a.may_affect,
        a.rectification_suggestions,
        a.audit_basis,
        a.audit_classification_id,
        a.auditing_experience,
        a.risk_assessment_id
        FROM
        user_attention_check b
        left join `plan_check_list` a on a.id = b.check_id
        left join entry_info rectify_situation_entry on pcl.rectify_situation_id=rectify_situation_entry.id and
        rectify_situation_entry.del_flag=0 and rectify_situation_entry.category_fk=6
        where a.del_flag='0'
        <if test="query.projectName!=null and query.projectName!=''">
            and a.project_name like concat('%',concat(#{query.projectName},'%'))
        </if>
        <if test="query.problemCharacterization!=null and query.problemCharacterization!=''">
            and a.problem_characterization like concat('%',concat(#{query.problemCharacterization},'%'))
        </if>
        <if test="query.problemDescription!=null and query.problemDescription!=''">
            and (a.problem_description like concat('%',concat(#{query.problemDescription},'%')) or
            a.problem_characterization like concat('%',concat(#{query.problemCharacterization},'%')))
        </if>
        <if test="query.deptId!=null and query.deptId!=''">
            and a.implementing_agency_id =#{query.deptId}
        </if>
        <if test="query.normalStatus!=null and query.normalStatus!=''">
            and a.status = #{query.normalStatus}
        </if>
        <if test="query.auditObj!=null and query.auditObj!=''">
            and a.audit_object_id = #{query.auditObj}
        </if>
        <if test="query.userId!=null and query.userId!=''">
            and b.user_id = #{query.userId}
        </if>
        <if test="query.rectifySituationId!=null and query.rectifySituationId!=''">
            and a.rectify_situation_id = #{query.rectifySituationId}
        </if>
    </select>
    <select id="findDeadlinePlan" resultType="java.lang.Integer">
        SELECT
        count(1)
        FROM
        `plan_check_list` a
         left join plan_time_temp t on a.id = t.plan_id
        where a.del_flag='0'
        and t.days>30
        and (imp_user_id=#{userId} or imp_admin_id=#{userId} or audit_user_id=#{userId}
        or audit_admin_id=#{userId})
        and status!=#{status}
    </select>
    <select id="getDeadlinePlanPage" resultMap="PlanCheckListMapper">
        SELECT
        <include refid="select"/>
        FROM
        `plan_check_list` a
        LEFT JOIN entry_info en3 on a.audit_nature_id = en3.id
        left join plan_time_temp t on a.id = t.plan_id
        where a.del_flag='0'
        and t.days>30
        and (imp_user_id=#{query.userId} or imp_admin_id=#{query.userId} or audit_user_id=#{query.userId}
        or audit_admin_id=#{query.userId})
        and status!=#{query.status}
    </select>
    <select id="findFilesByBizKey" resultType="gov.pbc.xjcloud.provider.contract.vo.PlanFileVO">
        select
        id,
        biz_key bizKey,
        task_id taskId,
        task_name taskName,
        file_uri fileUri,
        created_time createdTime,
        upload_user uploadUser
        from plan_files
        where biz_key=#{0} and length(file_uri)>0
    </select>

    <insert id="saveReturnPK" parameterType="gov.pbc.xjcloud.provider.contract.entity.PlanCheckList"
            useGeneratedKeys="true" keyProperty="planCheckList.id" keyColumn="id">
        INSERT INTO `plan_check_list`
        <trim prefix="(" suffix=")" suffixOverrides=",">
            `id`,
            `created_by`,
            `project_code`,
            `project_name`,
            `project_type`,
            `implementing_agency_id`,
            `audit_object_id`,
            `audit_nature_id`,
            `audit_year`,
            `question_entry_id`,
            `problem_severity_id`,
            `rectify_situation_id`,
            `problem_characterization`,
            `problem_description`,
            `may_affect`,
            `rectification_suggestions`,
            `audit_basis`,
            `audit_classification_id`,
            `auditing_experience`,
            `risk_assessment_id`,
            `imp_user_id`,
            `imp_admin_id`,
            `audit_user_id`,
            `audit_admin_id`,
            `status`
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            #{planCheckList.id},
            <if test="planCheckList.createdBy != null">
                #{planCheckList.createdBy},
            </if>
            <if test="planCheckList.projectCode != null">
                #{planCheckList.projectCode},
            </if>
            <if test="planCheckList.projectName != null">
                #{planCheckList.projectName},
            </if>
            <if test="planCheckList.projectType != null">
                #{planCheckList.projectType},
            </if>
            <if test="planCheckList.implementingAgencyId != null">
                #{planCheckList.implementingAgencyId},
            </if>
            <if test="planCheckList.auditObjectId != null">
                #{planCheckList.auditObjectId},
            </if>
            <if test="planCheckList.auditNatureId != null">
                #{planCheckList.auditNatureId},
            </if>
            <if test="planCheckList.auditYear != null">
                #{planCheckList.auditYear},
            </if>
            <if test="planCheckList.questionEntryId != null">
                #{planCheckList.questionEntryId},
            </if>
            <if test="planCheckList.problemSeverityId != null">
                #{planCheckList.problemSeverityId},
            </if>
            <if test="planCheckList.rectifySituationId != null">
                #{planCheckList.rectifySituationId},
            </if>
            <if test="planCheckList.problemCharacterization != null">
                #{planCheckList.problemCharacterization},
            </if>
            <if test="planCheckList.problemDescription != null">
                #{planCheckList.problemDescription},
            </if>
            <if test="planCheckList.mayAffect != null">
                #{planCheckList.mayAffect},
            </if>
            <if test="planCheckList.rectificationSuggestions != null">
                #{planCheckList.rectificationSuggestions},
            </if>
            <if test="planCheckList.auditBasis != null">
                #{planCheckList.auditBasis},
            </if>
            <if test="planCheckList.auditClassificationId != null">
                #{planCheckList.auditClassificationId},
            </if>
            <if test="planCheckList.auditingExperience != null">
                #{planCheckList.auditingExperience},
            </if>
            <if test="planCheckList.riskAssessmentId != null">
                #{planCheckList.riskAssessmentId},
            </if>
            <if test="planCheckList.impUserId != null">
                #{planCheckList.impUserId},
            </if>
            <if test="planCheckList.impAdminId != null">
                #{planCheckList.impAdminId},
            </if>
            <if test="planCheckList.auditUserId != null">
                #{planCheckList.auditUserId},
            </if>
            <if test="planCheckList.auditAdminId != null">
                #{planCheckList.auditAdminId},
            </if>
            <if test="planCheckList.status != null">
                #{planCheckList.status}
            </if>
        </trim>
    </insert>
    <insert id="addFileLog">
        insert into plan_files(id,upload_user,file_uri,created_time,biz_key,task_id,task_name)
         values(#{id},#{uploadUser},#{fileUri},#{createdTime},#{bizKey},#{taskId},#{taskName})
    </insert>
</mapper>